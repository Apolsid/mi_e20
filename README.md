# mi_e20

Скрипт для распаковки/упаковки языкового пакета для робота-пылесоса Xiaomi XiaoWa E20.
Основное назначение - создание пользовательских языковых пакетов.
Проверена для прошивки пылесоса 1.3.0_0542.
Скрипт написан для 3 версии python, на 2-ой не проверялся.

<b>Внимание!!</b> Все манипуляции Вы проводите на свой страх и риск, я не доконца изучил структура пакета, многие вещи остаются под вопросом. В моем случае никаких проблем с дальнейшей работой робота-пылесоса не возникло, но это не значит, что у вас будет также.

<H4>Команды:</H4>

```
unpack -p <dir> -f <file>
pack -p <dir>
serv --ip <IP> --port <PORT>
```


<H4>Инструкция:</H4>

1. Закачиваем оригинальный языковой пакет. Скрипт тестировался в основном на английском пакете, все манипуляции рекомендую проводить именно с ним. 
На текущей момент он доступен по тут <a href="https://awsbj0.fds.api.xiaomi.com/sapphire/app/voice-pkg/package/english.pkg">english.pkg</a>

2. Распаковываем пакет в отдельную директорию, по умолчанию "out".
```
python mi_e20 unpack -f english.pkg
```

3. Все аудио файлы в директории названы в порядке их записи в пакете. Например начальная мелодия загрузки - "0.mp3", соответственно при желании ее поменять, заменяем этот файл.
ВАЖНО! заменять необходимо строго с соблюдением точного наименование файла, включая расширение "mp3".

4. Запаковываем. Файл out.pkg будет лежать в "директории" со скриптом.
```
python mi_e20 pack
```

5. Для записи пакета необходим веб сервер, с которого пылесос загрузит пакет. Скриптом можно запустить просто веб сервер. В качестве IP указываем ваш IP в локальной сети. Для запуска на 80 порту возможно потребуются права администратора.
```
python mi_e20 serv --ip 192.168.1.111 --port 80
```

6. с помощью библиотеки <a href="https://github.com/rytilahti/python-miio">python-miio</a> даем команду на загрузку пакета.
Вам понадобиться ip пылесоса (например 192.168.1.125) в вашей локальной сети и его токен (например 6d373af1e425a35705b812cd81d8a5b2).
Как получить ip и токен можно посмотреть у старшей модели Roborock.
```
mirobo --ip=192.168.1.125 --token=6d373af1e425a35705b812cd81d8a5b2 raw_command user.dnld_install_sound '{"url":"http://192.168.1.111/out.pkg", "sver":1, "md5":"fc8f45999775089449019df9dbc3b2a9", "sid":3}'
```
В данном случае "sver" и "sid" жестко прописаны в скриптах и их менять не стоит. "md5" пылесос не проверяет, он может быть любой.
Для проверки состояния можно воспользоваться командой.
```
mirobo --ip=192.168.1.125 --token=6d373af1e425a35705b812cd81d8a5b2 raw_command  get_sound_progress
```

<a href="http://4pda.ru/forum/index.php?showtopic=901809">Тема на 4PDA</a>
